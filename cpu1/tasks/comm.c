/*
 * comm.c
 *
 *  Created on: 06.05.2021
 *      Author: local_marco
 */

//=============================================================================
/*-------------------------------- Includes ---------------------------------*/
//=============================================================================
#include "comm.h"

/* Kernel */
#include <ti/sysbios/BIOS.h>
#include <ti/sysbios/knl/Task.h>
#include <ti/sysbios/hal/Hwi.h>
#include <ti/sysbios/knl/Mailbox.h>

/* XDC */
#include <xdc/runtime/Error.h>

/* Device and drivers */
#include "device.h"
#include "driverlib.h"

/* Libs */
#include "clibs/bscia.h"
#include "clibs/serial.h"
#include "clibs/adc.h"
//=============================================================================

//=============================================================================
/*-------------------------------- Prototypes -------------------------------*/
//=============================================================================
static void commInitialize(void);

static int32_t commSerialRead(uint8_t *buffer, uint32_t to);
static int32_t commSerialWrite(uint8_t *buffer, uint32_t to);
//=============================================================================

//=============================================================================
/*--------------------------------- Globals ---------------------------------*/
//=============================================================================
static uint8_t commSerialBuffer[COMM_CONFIG_SERIAL_BUFFER_SIZE];
//=============================================================================

//=============================================================================
/*--------------------------------- Defines ---------------------------------*/
//=============================================================================
#define configCOMM_LED      DEVICE_GPIO_PIN_LED2
//=============================================================================

//=============================================================================
/*---------------------------------- Task -----------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void comm(UArg a0, UArg a1){

    commInitialize();

    serialRun();

    while(1);
}
//-----------------------------------------------------------------------------
//=============================================================================

//=============================================================================
/*---------------------------- Static functions -----------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
static void commInitialize(void){

    /* Initializes sets the GPIO pin as a push-pull output */
//    Device_initGPIO();
    GPIO_setPadConfig(configCOMM_LED, GPIO_PIN_TYPE_STD);
    GPIO_setDirectionMode(configCOMM_LED, GPIO_DIR_MODE_OUT);

    /* Initialize the serial comm. interface */
    bsciaInitialize();

    /* Serial lib */
    serialInitialize(commSerialBuffer, sizeof(commSerialBuffer), commSerialRead, commSerialWrite);
}
//-----------------------------------------------------------------------------
static int32_t commSerialRead(uint8_t *buffer, uint32_t to){

    if( bsciaRead(buffer, 1, to) != 1 ) return 1;

    return 0;
}
//-----------------------------------------------------------------------------
static int32_t commSerialWrite(uint8_t *buffer, uint32_t to){

    if( bsciaWrite(buffer, 1, to) != 1 ) return 1;

    return 0;
}
//-----------------------------------------------------------------------------
//=============================================================================
