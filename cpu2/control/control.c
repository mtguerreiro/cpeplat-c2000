/*
 * control.c
 *
 *  Created on: 22.07.2021
 *      Author: mguerreiro
 */

//===========================================================================
/*-------------------------------- Includes -------------------------------*/
//===========================================================================
#include "control.h"

#include "openloop.h"
#include "pid.h"
//===========================================================================

//===========================================================================
/*------------------------------- Prototypes ------------------------------*/
//===========================================================================

//===========================================================================

//===========================================================================
/*-------------------------------- Globals --------------------------------*/
//===========================================================================
controlMode_t controlMode[CONTROL_MODE_END];

openloop_t openloop;
pid_t pid;
//===========================================================================

//===========================================================================
/*------------------------------- Functions -------------------------------*/
//===========================================================================
//---------------------------------------------------------------------------
void controlInitialize(void){

//    controlMode[CONTROL_MODE_OL].set = openloopSet;
    controlMode[CONTROL_MODE_OL].run = openloopControl;
    controlMode[CONTROL_MODE_OL].controller = (void *)&openloop;

//    controlMode[CONTROL_MODE_PID].set = pidSet;
    controlMode[CONTROL_MODE_PID].run = pidControl;
    controlMode[CONTROL_MODE_PID].controller = (void *)&pid;
}
//---------------------------------------------------------------------------
uint32_t controlSet(controlModeEnum_t mode, uint32_t *p){

    if( mode == CONTROL_MODE_OL ){
        float dc;

        dc = *((float *)(p));

        openloopInitialize(&openloop, dc);
    }

    else if( mode == CONTROL_MODE_PID ){
        float a1, a2, b0, b1, b2;

        a1 = *((float *)(&p[0]));
        a2 = *((float *)(&p[1]));
        b0 = *((float *)(&p[2]));
        b1 = *((float *)(&p[3]));
        b2 = *((float *)(&p[4]));

        pidInitialize(&pid, a1, a2, b0, b1, b2);
    }

    else{
        return 1;
    }


    return 0;
}
//---------------------------------------------------------------------------
float controlControl(controlModeEnum_t mode, uint16_t ref, platCPU2ControlData_t *data){

    float u;

    u = controlMode[mode].run(controlMode[mode].controller, ref, data);

    return u;
}
//---------------------------------------------------------------------------
//===========================================================================

//===========================================================================
/*--------------------------- Static functions ----------------------------*/
//===========================================================================
//---------------------------------------------------------------------------
//---------------------------------------------------------------------------
//===========================================================================
