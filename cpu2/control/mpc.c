/*
 * mpc.c
 *
 *  Created on: 02.08.2021
 *      Author: LRS
 */

//===========================================================================
/*------------------------------- Includes --------------------------------*/
//===========================================================================
#include "mpc.h"
#include "dmpc.h"
#include "dmpc_defs.h"
//===========================================================================

//===========================================================================
/*------------------------------- Functions -------------------------------*/
//===========================================================================
//---------------------------------------------------------------------------
void mpcInitialize(void *mpct, uint32_t *p){

    mpc_t *mpc;

    mpc = (mpc_t *)mpct;

    mpc->x[0] = 0;
    mpc->x[1] = 0;

    mpc->x_1[0] = 0;
    mpc->x_1[1] = 0;

    mpc->u = 0;
    mpc->u_1 = 0;
    mpc->du = 0;

    mpc->iters = 0;
}
//---------------------------------------------------------------------------
float mpcControl(void *mpct, uint16_t ref, platCPU2ControlData_t *data){

    static uint32_t i = 0;

//    static float reff[] = {6.5 ,  6.68,  6.86,  7.04,  7.22,  7.4 ,  7.58,  7.76,  7.94,
//                           8.12,  8.3 ,  8.48,  8.66,  8.84,  9.02,  9.2 ,  9.38,  9.56,
//                           9.74,  9.92, 10.1 , 10.28, 10.46, 10.64, 10.82, 11.  , 11.18,
//                          11.36, 11.54, 11.72, 11.9 , 12.08, 12.26, 12.44, 12.62, 12.8 ,
//                          12.98, 13.16, 13.34, 13.52, 13.7 , 13.88, 14.06, 14.24, 14.42,
//                          14.6 , 14.78, 14.96, 15.14, 15.32, 15.5 , 15.32, 15.14, 14.96,
//                          14.78, 14.6 , 14.42, 14.24, 14.06, 13.88, 13.7 , 13.52, 13.34,
//                          13.16, 12.98, 12.8 , 12.62, 12.44, 12.26, 12.08, 11.9 , 11.72,
//                          11.54, 11.36, 11.18, 11.  , 10.82, 10.64, 10.46, 10.28, 10.1 ,
//                           9.92,  9.74,  9.56,  9.38,  9.2 ,  9.02,  8.84,  8.66,  8.48,
//                           8.3 ,  8.12,  7.94,  7.76,  7.58,  7.4 ,  7.22,  7.04,  6.86,
//                           6.68,  6.5 ,  6.68,  6.86,  7.04,  7.22,  7.4 ,  7.58,  7.76,
//                           7.94,  8.12,  8.3 ,  8.48,  8.66,  8.84,  9.02,  9.2 ,  9.38,
//                           9.56,  9.74,  9.92, 10.1 , 10.28, 10.46, 10.64, 10.82, 11.  ,
//                          11.18, 11.36, 11.54, 11.72, 11.9 , 12.08, 12.26, 12.44, 12.62,
//                          12.8 , 12.98, 13.16, 13.34, 13.52, 13.7 , 13.88, 14.06, 14.24,
//                          14.42, 14.6 , 14.78, 14.96, 15.14, 15.32, 15.5 , 15.32, 15.14,
//                          14.96, 14.78, 14.6 , 14.42, 14.24, 14.06, 13.88, 13.7 , 13.52,
//                          13.34, 13.16, 12.98, 12.8 , 12.62, 12.44, 12.26, 12.08, 11.9 ,
//                          11.72, 11.54, 11.36, 11.18, 11.  , 10.82, 10.64, 10.46, 10.28,
//                          10.1 ,  9.92,  9.74,  9.56,  9.38,  9.2 ,  9.02,  8.84,  8.66,
//                           8.48,  8.3 ,  8.12,  7.94,  7.76,  7.58,  7.4 ,  7.22,  7.04,
//                           6.86,  6.68,  6.5 ,  6.68,  6.86,  7.04,  7.22,  7.4 ,  7.58,
//                           7.76,  7.94,  8.12,  8.3 ,  8.48,  8.66,  8.84,  9.02,  9.2 ,
//                           9.38,  9.56,  9.74,  9.92, 10.1 , 10.28, 10.46, 10.64, 10.82,
//                          11.  , 11.18, 11.36, 11.54, 11.72, 11.9 , 12.08, 12.26, 12.44,
//                          12.62, 12.8 , 12.98, 13.16, 13.34, 13.52, 13.7 , 13.88, 14.06,
//                          14.24, 14.42, 14.6 , 14.78, 14.96, 15.14, 15.32, 15.5 , 15.32,
//                          15.14, 14.96, 14.78, 14.6 , 14.42, 14.24, 14.06, 13.88, 13.7 ,
//                          13.52, 13.34, 13.16, 12.98, 12.8 , 12.62, 12.44, 12.26, 12.08,
//                          11.9 , 11.72, 11.54, 11.36, 11.18, 11.  , 10.82, 10.64, 10.46,
//                          10.28, 10.1 ,  9.92,  9.74,  9.56,  9.38,  9.2 ,  9.02,  8.84,
//                           8.66,  8.48,  8.3 ,  8.12,  7.94,  7.76,  7.58,  7.4 ,  7.22,
//                           7.04,  6.86,  6.68,  6.5 ,  6.68,  6.86,  7.04,  7.22,  7.4 ,
//                           7.58,  7.76,  7.94,  8.12,  8.3 ,  8.48,  8.66,  8.84,  9.02,
//                           9.2 ,  9.38,  9.56,  9.74,  9.92, 10.1 , 10.28, 10.46, 10.64,
//                          10.82, 11.  , 11.18, 11.36, 11.54, 11.72, 11.9 , 12.08, 12.26,
//                          12.44, 12.62, 12.8 , 12.98, 13.16, 13.34, 13.52, 13.7 , 13.88,
//                          14.06, 14.24, 14.42, 14.6 , 14.78, 14.96, 15.14, 15.32, 15.5 ,
//                          15.32, 15.14, 14.96, 14.78, 14.6 , 14.42, 14.24, 14.06, 13.88,
//                          13.7 , 13.52, 13.34, 13.16, 12.98, 12.8 , 12.62, 12.44, 12.26,
//                          12.08, 11.9 , 11.72, 11.54, 11.36, 11.18, 11.  , 10.82, 10.64,
//                          10.46, 10.28, 10.1 ,  9.92,  9.74,  9.56,  9.38,  9.2 ,  9.02,
//                           8.84,  8.66,  8.48,  8.3 ,  8.12,  7.94,  7.76,  7.58,  7.4 ,
//                           7.22,  7.04,  6.86,  6.68,  6.5 ,  6.68,  6.86,  7.04,  7.22,
//                           7.4 ,  7.58,  7.76,  7.94,  8.12,  8.3 ,  8.48,  8.66,  8.84,
//                           9.02,  9.2 ,  9.38,  9.56,  9.74,  9.92, 10.1 , 10.28, 10.46,
//                          10.64, 10.82, 11.  , 11.18, 11.36, 11.54, 11.72, 11.9 , 12.08,
//                          12.26, 12.44, 12.62, 12.8 , 12.98, 13.16, 13.34, 13.52, 13.7 ,
//                          13.88, 14.06, 14.24, 14.42, 14.6 , 14.78, 14.96, 15.14, 15.32,
//                          15.5 , 15.32, 15.14, 14.96, 14.78, 14.6 , 14.42, 14.24, 14.06,
//                          13.88, 13.7 , 13.52, 13.34, 13.16, 12.98, 12.8 , 12.62, 12.44,
//                          12.26, 12.08, 11.9 , 11.72, 11.54, 11.36, 11.18, 11.  , 10.82,
//                          10.64, 10.46, 10.28, 10.1 ,  9.92,  9.74,  9.56,  9.38,  9.2 ,
//                           9.02,  8.84,  8.66,  8.48,  8.3 ,  8.12,  7.94,  7.76,  7.58,
//                           7.4 ,  7.22,  7.04,  6.86,  6.68,  6.5 ,  6.68,  6.86,  7.04,
//                           7.22,  7.4 ,  7.58,  7.76,  7.94,  8.12,  8.3 ,  8.48,  8.66,
//                           8.84,  9.02,  9.2 ,  9.38,  9.56,  9.74,  9.92, 10.1 , 10.28,
//                          10.46, 10.64, 10.82, 11.  , 11.18, 11.36, 11.54, 11.72, 11.9 ,
//                          12.08, 12.26, 12.44, 12.62, 12.8 , 12.98, 13.16, 13.34, 13.52,
//                          13.7 , 13.88, 14.06, 14.24, 14.42, 14.6 , 14.78, 14.96, 15.14,
//                          15.32, 15.5 , 15.32, 15.14, 14.96, 14.78, 14.6 , 14.42, 14.24,
//                          14.06, 13.88, 13.7 , 13.52, 13.34, 13.16, 12.98, 12.8 , 12.62,
//                          12.44, 12.26, 12.08, 11.9 , 11.72, 11.54, 11.36, 11.18, 11.  ,
//                          10.82, 10.64, 10.46, 10.28, 10.1 ,  9.92,  9.74,  9.56,  9.38,
//                           9.2 ,  9.02,  8.84,  8.66,  8.48,  8.3 ,  8.12,  7.94,  7.76,
//                           7.58,  7.4 ,  7.22,  7.04,  6.86,  6.68};

    static float r[DMPC_CONFIG_NY] = {0.0};

    static float xm[DMPC_CONFIG_NXM] = {0.0};
    static float xm_1[DMPC_CONFIG_NXM] = {0.0};

    static float u[DMPC_CONFIG_NU + DMPC_CONFIG_ND] = {0.0};
    //static float u_1[1] = {0.0};
    static float du[DMPC_CONFIG_NU + DMPC_CONFIG_ND] = {0.0};

    static uint32_t iters;

    /* Reference */
    r[0] =((float)ref) * ((float)PLAT_CONFIG_GAIN_REF);

    /* Output current */
    //u[1] = (((float)*data->adc[PLAT_CONFIG_BUCK_IO_BUFFER]) * ((float)PLAT_CONFIG_BUCK_IO_GAIN)) + ((float)PLAT_CONFIG_BUCK_IO_OFFS);

    /* Assembles state vector */
    xm[0] = (((float)*data->adc[PLAT_CONFIG_BUCK_IL_BUFFER]) * ((float)PLAT_CONFIG_BUCK_IL_GAIN)) + ((float)PLAT_CONFIG_BUCK_IL_OFFS);
    xm[1] = ((float)(*data->adc[PLAT_CONFIG_BUCK_V_OUT_BUCK_BUFFER])) * ((float)PLAT_CONFIG_BUCK_V_OUT_BUCK_GAIN);

    //xm_1[0] = xm[0];
    //xm_1[1] = xm[1];

    /* Delay compensation */
    dmpcDelayComp(xm, xm, u);

    /* Optimization */
    dmpcOpt(xm, xm_1, r, u, &iters, du);
    //dmpcOpt(xm, xm_1, &reff[i++], u, &iters, du);

    /* Computes u = du + u_1 */
    u[0] = du[0] + u[0];

    xm_1[0] = xm[0];
    xm_1[1] = xm[1];

    if( i >= 400 ) i = 0;

    //return u[0] / 20.0f;
    return u[0] / 16.0f;
}
//---------------------------------------------------------------------------
//===========================================================================
